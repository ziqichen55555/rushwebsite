{% extends 'base.html' %}
{% load booking_extras %}

{% block title %}Payment - Rush Car Rental{% endblock %}

{% block extra_head %}
<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<style>
    /* Stripe Elements styles */
    .StripeElement {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
        box-shadow: 0 1px 3px 0 #e6ebf1;
        -webkit-transition: box-shadow 150ms ease;
        transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
        border-color: #80bdff;
    }

    .StripeElement--invalid {
        border-color: #fa755a;
    }

    .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
    }
    
    #payment-message {
        display: none;
        color: #dc3545;
        margin-top: 8px;
    }
    
    #loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
        margin-left: 12px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Custom Modal */
    #payment-confirm-modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 1050;
    }
    
    .modal-overlay {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }
    
    .modal-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 500px;
        width: 90%;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .modal-header {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        background-color: #f8f9fa;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.25rem;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        padding: 15px;
        border-top: 1px solid #e9ecef;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Breadcrumb -->
<div class="breadcrumb-container py-2">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'home' %}" class="breadcrumb-home">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'car_detail' temp_booking.car.id %}">
                        <i class="fas fa-car"></i> {{ temp_booking.car.make }} {{ temp_booking.car.model }}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'add_options' temp_booking_id %}">
                        <i class="fas fa-plus-circle"></i> Options
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-credit-card"></i> Payment
                </li>
            </ol>
        </nav>
    </div>
</div>

<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mb-4">
                <h1 class="mb-4">Confirm Payment</h1>
                <p class="lead mb-4">Please complete payment to confirm your reservation</p>
                
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <form id="payment-form" method="post" action="{% url 'process_payment' temp_booking_id %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="confirm">
                            
                            <div class="mb-4">
                                <h6 class="mb-3">Card Information</h6>
                                
                                <div class="form-group mb-3">
                                    <label for="card-element" class="form-label">Credit or Debit Card</label>
                                    <div id="card-element" class="form-control">
                                        <!-- Stripe Elements will be inserted here -->
                                        <div class="mock-card-form">
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <label for="card_number" class="form-label">Card Number</label>
                                                    <input type="text" class="form-control" name="card_number" id="card_number" placeholder="1234 5678 9012 3456" maxlength="19" required>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="expiry_date" class="form-label">Expiry Date</label>
                                                    <input type="text" class="form-control" name="expiry_date" id="expiry_date" placeholder="MM/YY" maxlength="5" required>
                                                </div>
                                                <div class="col-6">
                                                    <label for="cvc" class="form-label">CVC</label>
                                                    <input type="text" class="form-control" name="cvc" id="cvc" placeholder="123" maxlength="3" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="payment-message" class="alert alert-danger" role="alert"></div>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Billing Information</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">Cardholder Name</label>
                                        <input type="text" class="form-control" id="name" name="name" required value="{{ request.user.get_full_name }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" name="email" required value="{{ request.user.email }}">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" name="terms_accepted" id="terms_accepted" required>
                                <label class="form-check-label" for="terms_accepted">
                                    I agree to the <a href="{% url 'rental_conditions' %}" target="_blank">Rental Conditions</a> and <a href="{% url 'refund_policy' %}" target="_blank">Refund Policy</a>
                                </label>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button id="submit-button" class="btn btn-warning btn-lg" type="button">Continue to Payment</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Booking Details Summary -->
            <div class="col-lg-4">
                <div class="card shadow sticky-top" style="top: 20px; z-index: 1">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Booking Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <img src="{{ temp_booking.car.image_url }}" alt="{{ temp_booking.car.make }} {{ temp_booking.car.model }}" class="rounded" width="60" height="45" style="object-fit: cover;">
                            <div class="ms-3">
                                <h6 class="mb-0">{{ temp_booking.car.year }} {{ temp_booking.car.make }} {{ temp_booking.car.model }}</h6>
                                <small class="text-muted">{{ temp_booking.car.category.name }}</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <i class="fas fa-calendar-alt text-warning me-2"></i> Rental Period:
                                </div>
                                <div class="text-end">{{ temp_booking.duration_days }} day(s)</div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <i class="fas fa-map-marker-alt text-warning me-2"></i> Pick-up:
                                </div>
                                <div class="text-end">{{ temp_booking.pickup_date|date:"M d, Y" }}</div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <i class="fas fa-map-marker-alt text-warning me-2"></i> Drop-off:
                                </div>
                                <div class="text-end">{{ temp_booking.return_date|date:"M d, Y" }}</div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <h6 class="mb-3">Cost Breakdown</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <div>Base Rate ({{ temp_booking.duration_days }} days)</div>
                                <div>${{ temp_booking.car.daily_rate|multiply:temp_booking.duration_days|floatformat:2 }}</div>
                            </div>
                            
                            {% if temp_booking.damage_waiver %}
                            <div class="d-flex justify-content-between mb-2">
                                <div>Damage Waiver</div>
                                <div>$18.00</div>
                            </div>
                            {% endif %}
                            
                            {% if temp_booking.extended_area %}
                            <div class="d-flex justify-content-between mb-2">
                                <div>Extended Area Cover</div>
                                <div>$10.00</div>
                            </div>
                            {% endif %}
                            
                            {% if temp_booking.satellite_navigation %}
                            <div class="d-flex justify-content-between mb-2">
                                <div>GPS Navigation</div>
                                <div>$14.95</div>
                            </div>
                            {% endif %}
                            
                            {% if temp_booking.child_seats > 0 %}
                            <div class="d-flex justify-content-between mb-2">
                                <div>Child Seats ({{ temp_booking.child_seats }})</div>
                                <div>${{ temp_booking.child_seats|multiply:8.50|floatformat:2 }}</div>
                            </div>
                            {% endif %}
                            
                            {% if temp_booking.additional_drivers > 0 %}
                            <div class="d-flex justify-content-between mb-2">
                                <div>Additional Drivers ({{ temp_booking.additional_drivers }})</div>
                                <div>${{ temp_booking.additional_drivers|multiply:5.00|floatformat:2 }}</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-0">
                            <div><strong>Total Amount</strong></div>
                            <div><strong class="text-warning">${{ total_cost|floatformat:2 }}</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Payment Confirmation Modal -->
<div id="payment-confirm-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
            <div class="card">
                <div class="card-body p-3">
                    <table class="table table-striped mb-0">
                        <tbody>
                            <tr>
                                <th style="width: 40%;">Vehicle:</th>
                                <td>{{ temp_booking.car.year }} {{ temp_booking.car.make }} {{ temp_booking.car.model }}</td>
                            </tr>
                            <tr>
                                <th>Pick-up:</th>
                                <td>{{ temp_booking.pickup_location.name }}, {{ temp_booking.pickup_date|date:"M d, Y" }}</td>
                            </tr>
                            <tr>
                                <th>Drop-off:</th>
                                <td>{{ temp_booking.dropoff_location.name }}, {{ temp_booking.return_date|date:"M d, Y" }}</td>
                            </tr>
                            <tr>
                                <th>Duration:</th>
                                <td>{{ temp_booking.duration_days }} day(s)</td>
                            </tr>
                            <tr>
                                <th>Total Amount:</th>
                                <td><strong>${{ total_cost|floatformat:2 }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="cancel-payment" class="btn btn-outline-secondary">Cancel</button>
            <button type="button" id="confirm-payment" class="btn btn-warning">Confirm Payment</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const submitButton = document.getElementById("submit-button");
        const paymentForm = document.getElementById("payment-form");
        const modal = document.getElementById("payment-confirm-modal");
        const confirmPaymentBtn = document.getElementById("confirm-payment");
        const cancelPaymentBtn = document.getElementById("cancel-payment");
        const modalOverlay = document.querySelector(".modal-overlay");
        
        // Format card number with spaces
        const cardNumberInput = document.querySelector("input[name='card_number']");
        if (cardNumberInput) {
            cardNumberInput.addEventListener("input", function(e) {
                let value = e.target.value.replace(/\s+/g, "");
                if (value.length > 0) {
                    value = value.match(new RegExp('.{1,4}', 'g')).join(" ");
                }
                e.target.value = value;
            });
        }
        
        // Format expiry date with slash
        const expiryInput = document.querySelector("input[name='expiry_date']");
        if (expiryInput) {
            expiryInput.addEventListener("input", function(e) {
                let value = e.target.value.replace(/\D/g, "");
                if (value.length > 2) {
                    value = value.substring(0, 2) + "/" + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }
        
        // Show payment modal
        submitButton.addEventListener("click", function() {
            // Basic form validation
            if (paymentForm.checkValidity()) {
                modal.style.display = "block";
            } else {
                paymentForm.reportValidity();
            }
        });
        
        // Hide modal when clicking cancel
        cancelPaymentBtn.addEventListener("click", function() {
            modal.style.display = "none";
        });
        
        // Submit form when clicking confirm
        confirmPaymentBtn.addEventListener("click", function() {
            paymentForm.submit();
        });
        
        // Close modal when clicking outside
        modalOverlay.addEventListener("click", function() {
            modal.style.display = "none";
        });
    });
</script>
{% endblock %}
