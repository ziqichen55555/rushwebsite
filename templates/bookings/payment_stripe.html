{% extends 'base.html' %}
{% load static %}
{% load booking_extras %}

{% block title %}Payment - {{ temp_booking.car.make }} {{ temp_booking.car.model }}{% endblock %}

{% block extra_css %}
<style>
    .payment-form label {
        font-weight: 500;
    }
    
    .payment-form .form-control {
        border-radius: 0.5rem;
    }
    
    .payment-details-card {
        background-color: #f8f9fa;
        border-left: 4px solid #ffc107;
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050;
    }
    
    #payment-confirm-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1051;
        max-width: 90%;
        width: 550px;
    }
    
    .price-comparison {
        font-size: 0.9rem;
    }
    
    .price-comparison .competitor-price {
        text-decoration: line-through;
        color: #dc3545;
    }
    
    /* Stripe Elements Custom Styling */
    .stripe-form {
        width: 100%;
        padding: 15px;
    }
    
    #stripe-payment-element {
        margin-bottom: 24px;
    }
    
    #payment-element {
        margin-bottom: 24px;
    }
    
    #payment-message {
        color: rgb(105, 115, 134);
        font-size: 16px;
        line-height: 20px;
        padding-top: 12px;
        text-align: center;
    }
    
    #payment-message.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="container-fluid bg-dark text-white py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1>Complete Your Booking</h1>
                <p class="mb-0">Almost there! Please provide your payment details to complete your booking.</p>
            </div>
            <div class="col-md-6 d-none d-md-block text-end">
                <img src="{% static 'images/secure-payment.svg' %}" alt="Secure Payment" class="img-fluid" style="max-height: 100px;">
            </div>
        </div>
    </div>
</section>

<!-- Content Section -->
<section class="container my-5">
    <div class="row">
        <!-- Breadcrumb -->
        <div class="col-12 mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-custom mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home' %}" class="breadcrumb-home">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'car_detail' temp_booking.car.id %}">
                            <i class="fas fa-car"></i> {{ temp_booking.car.make }} {{ temp_booking.car.model }}
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'add_options' temp_booking_id %}">
                            <i class="fas fa-plus-circle"></i> Options
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="fas fa-credit-card"></i> Payment
                    </li>
                </ol>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Payment Information
                    </h5>
                </div>
                <div class="card-body">
                    <form id="payment-form" class="payment-form">
                        {% csrf_token %}
                        
                        <!-- Payment Method Selection -->
                        <div class="mb-4">
                            <label class="form-label">Payment Method</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card border h-100">
                                        <div class="card-body p-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card" checked>
                                                <label class="form-check-label w-100" for="credit_card">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span>Credit Card</span>
                                                        <div>
                                                            <i class="fab fa-cc-visa fa-lg text-primary me-1"></i>
                                                            <i class="fab fa-cc-mastercard fa-lg text-danger me-1"></i>
                                                            <i class="fab fa-cc-amex fa-lg text-info"></i>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border h-100">
                                        <div class="card-body p-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_method" id="paypal" value="paypal" disabled>
                                                <label class="form-check-label w-100" for="paypal">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span>PayPal</span>
                                                        <i class="fab fa-paypal fa-lg text-primary"></i>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Credit Card Information (Stripe Elements) -->
                        <div id="credit-card-form">
                            <div id="payment-element" class="mb-4">
                                <!-- Stripe Elements Placeholder -->
                            </div>
                            <div id="payment-message" class="hidden"></div>
                        </div>
                        
                        <!-- Terms Acceptance -->
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" name="terms_accepted" id="terms_accepted" required>
                            <label class="form-check-label" for="terms_accepted">
                                I agree to the <a href="{% url 'rental_conditions' %}" target="_blank">Rental Conditions</a> and <a href="{% url 'refund_policy' %}" target="_blank">Refund Policy</a>
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button id="submit-button" class="btn btn-warning btn-lg" type="submit">
                                <span id="button-text">Pay Now (${{'%0.2f'|format:total_cost}})</span>
                                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Booking Details Summary -->
        <div class="col-lg-4">
            <div class="card shadow sticky-top" style="top: 20px; z-index: 1">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Booking Summary</h5>
                </div>
                <div class="card-body">
                    <!-- Car Details -->
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <img src="{{ temp_booking.car.image_url }}" alt="{{ temp_booking.car.make }} {{ temp_booking.car.model }}" class="rounded" width="80">
                        </div>
                        <div class="ms-3">
                            <h5 class="mb-1">{{ temp_booking.car.make }} {{ temp_booking.car.model }}</h5>
                            <div class="small text-muted">
                                <span class="me-2"><i class="fas fa-car"></i> {{ temp_booking.car.category.name }}</span>
                                <span class="me-2"><i class="fas fa-users"></i> {{ temp_booking.car.seats }} seats</span>
                                <span><i class="fas fa-cog"></i> {{ temp_booking.car.get_transmission_display }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rental Details -->
                    <div class="card payment-details-card mb-3">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span><i class="fas fa-calendar-alt text-secondary me-2"></i>Pickup Date:</span>
                                <span class="fw-bold">{{ temp_booking.pickup_date }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span><i class="fas fa-calendar-alt text-secondary me-2"></i>Return Date:</span>
                                <span class="fw-bold">{{ temp_booking.return_date }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span><i class="fas fa-map-marker-alt text-secondary me-2"></i>Pickup:</span>
                                <span class="fw-bold">{{ temp_booking.pickup_location.name }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-map-marker-alt text-secondary me-2"></i>Return:</span>
                                <span class="fw-bold">{{ temp_booking.dropoff_location.name }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost Breakdown -->
                    <h6 class="mb-2">Cost Breakdown</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Daily Rate</span>
                        <span>${{ temp_booking.car.daily_rate }} x {{ temp_booking.duration_days }} days</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Base Cost</span>
                        <span>${{ temp_booking.car.daily_rate|multiply:temp_booking.duration_days }}</span>
                    </div>
                    
                    {% if temp_booking.damage_waiver %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Damage Waiver</span>
                        <span>$15 x {{ temp_booking.duration_days }} days</span>
                    </div>
                    {% endif %}
                    
                    {% if temp_booking.extended_area %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Extended Area Cover</span>
                        <span>$20 x {{ temp_booking.duration_days }} days</span>
                    </div>
                    {% endif %}
                    
                    {% if temp_booking.satellite_navigation %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Satellite Navigation</span>
                        <span>$10 x {{ temp_booking.duration_days }} days</span>
                    </div>
                    {% endif %}
                    
                    {% if temp_booking.child_seats > 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Child Seats ({{ temp_booking.child_seats }})</span>
                        <span>${{ temp_booking.child_seats|multiply:5 }} x {{ temp_booking.duration_days }} days</span>
                    </div>
                    {% endif %}
                    
                    {% if temp_booking.additional_drivers > 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Additional Drivers ({{ temp_booking.additional_drivers }})</span>
                        <span>${{ temp_booking.additional_drivers|multiply:10 }} x {{ temp_booking.duration_days }} days</span>
                    </div>
                    {% endif %}
                    
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-0">
                        <h5 class="mb-0">Total</h5>
                        <h5 class="mb-0 text-primary">${{ total_cost }}</h5>
                    </div>
                    
                    <!-- Price Comparison -->
                    {% if temp_booking.car.comparison_provider1_rate %}
                    <div class="mt-3 price-comparison">
                        <p class="mb-1">
                            <i class="fas fa-tags text-success me-1"></i> Save up to 
                            <strong class="text-success">
                                ${{ temp_booking.car.comparison_provider1_rate|subtract:temp_booking.car.daily_rate|multiply:temp_booking.duration_days }}
                            </strong> 
                            compared to other providers
                        </p>
                        <div class="d-flex justify-content-between">
                            <span>{{ temp_booking.car.comparison_provider1_name }}</span>
                            <span class="competitor-price">${{ temp_booking.car.comparison_provider1_rate|multiply:temp_booking.duration_days }}</span>
                        </div>
                        {% if temp_booking.car.comparison_provider2_rate %}
                        <div class="d-flex justify-content-between">
                            <span>{{ temp_booking.car.comparison_provider2_name }}</span>
                            <span class="competitor-price">${{ temp_booking.car.comparison_provider2_rate|multiply:temp_booking.duration_days }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize Stripe
        const stripe = Stripe('{{ stripe_public_key }}');
        
        // Create the payment form elements
        const paymentForm = document.getElementById('payment-form');
        const options = {
            clientSecret: '{{ client_secret }}',
            appearance: {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#ffc107',
                    colorBackground: '#ffffff',
                    colorText: '#212529',
                    colorDanger: '#dc3545',
                    fontFamily: 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    borderRadius: '0.5rem',
                    fontLineHeight: '1.5',
                },
            },
        };
        
        // Create and mount the Payment Element
        const elements = stripe.elements(options);
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
        // Handle form submission
        paymentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Check if terms are accepted
            if (!document.getElementById('terms_accepted').checked) {
                const messageElement = document.getElementById('payment-message');
                messageElement.textContent = 'You must accept the rental conditions and refund policy.';
                messageElement.classList.remove('hidden');
                return;
            }
            
            // Disable the submit button and show spinner during processing
            setLoading(true);
            
            const {error} = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: '{{ request.build_absolute_uri }}stripe-success/{{ temp_booking_id }}/',
                },
            });
            
            if (error) {
                // Show error to customer
                const messageElement = document.getElementById('payment-message');
                messageElement.textContent = error.message;
                messageElement.classList.remove('hidden');
                setLoading(false);
            }
            // Otherwise, the page will be redirected to the return_url
        });
        
        function setLoading(isLoading) {
            const button = document.getElementById('submit-button');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('button-text');
            
            if (isLoading) {
                button.disabled = true;
                spinner.classList.remove('d-none');
                buttonText.classList.add('d-none');
            } else {
                button.disabled = false;
                spinner.classList.add('d-none');
                buttonText.classList.remove('d-none');
            }
        }
    });
</script>
{% endblock %}
